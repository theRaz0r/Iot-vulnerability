# 蓝牙


## 协议栈总览
![](vx_images/60864426982213.png)
## GAP－通用访问规范

BLE设备的链接与加密、签名协议的协商在这一层，比如BLE的两种安全模式，首先是Security Mode 1，这个模式主要负责“加密”，它含有三个安全等级：

Level 1 无认证无加密，链路默认模式。我手头有的设备默认都是这个等级，不靠谱…
Level 2 带加密的未认证配对
Level 3 带加密的认证配对

其次是Security Mode 2，这个模式主要负责“签名”，它含有两个安全等级：

Level 1：带数据签名的未认证配对
Level 2：带数据签名的认证配对


# GATT
在gatt服务器中，属性被分组为服务service ,每个服务包含0个或者多个characteristic ,不同特征之间用uuid来区分，这些特征又可以包含0到多个描述符。


本次对ble流量进行嗅探和抓包，起始就是分析数据报中的gatt协议，修改其中字段，进行重放攻击。


# wireshark    &&    nrf_sniff   

用bt5032u抓包

通过收集app操作智能灯泡，wireshark过滤中输入btatt, 只过滤gatt协议


在att 数据包中，sent write request 请求中，修改了handle 0x0012句柄的属性值0e000000000000000000000418020181
这个属性值对蓝牙灯泡发起了开启灯泡指令。
![](vx_images/143507886034492.png)




# parani-ud100重放攻击

检查设备是否识别成功
![](vx_images/424133596343023.png)

扫描周围设备
![](vx_images/595525553608852.png)

![](vx_images/182605800865393.png)


执行gatttool，连接设备 
```
 gatttool -b F0:45:DA:F4:13:E4 -I
 connect
```

![](vx_images/515154389253917.png)


![](vx_images/556647888211705.png)

查看BLE协议中的句柄，通过抓包的数据，分析是要给0x12句柄修改值。
![](vx_images/309177474011611.png)


![](vx_images/503278287291552.png)

最后一位0表示关灯，1表示开灯

发送后，开关灯成功。

---

